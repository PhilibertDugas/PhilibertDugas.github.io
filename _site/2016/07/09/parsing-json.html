<!DOCTYPE html>
<html>
  <head>
    <!-- Begin Jekyll SEO tag v2.0.0 -->
<title>Parsing Json - Philibert&#8217;s website</title>
<meta property="og:title" content="Parsing Json" />
<meta name="description" content="Parsing JSON and sending requests" />
<meta property="og:description" content="Parsing JSON and sending requests" />
<meta property="og:site_name" content="Philibert’s website" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2016-07-09T00:00:00-04:00" />
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "Parsing Json",
    "datePublished": "2016-07-09T00:00:00-04:00",
    "description": "Parsing JSON and sending requests",
    "url": "/2016/07/09/parsing-json.html"
  }
</script>
<!-- End Jekyll SEO tag -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="keywords" content="Philibert Dugas, Philibertd">
    <meta name="author" content="Philibert Dugas">
    <link href="/favicon.ico" rel="shortcut icon" type="image/x-icon">
    <link href="/static/css/skeleton.css" rel="stylesheet">
    <link href="/static/css/style.css" rel="stylesheet">
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-76867217-1', 'auto');
      ga('send', 'pageview');
    </script>
  </head>

  <body>
    <div class="container">
  <div class="row">
    <div class="profile three columns">
      <a href="/"><img id="avatar" src="/static/images/phili.png" alt="avatar"/></a>
      <ul id="social">
        <li>
          <a href="https://ca.linkedin.com/in/philibertdugas" target="_blank"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M365 1414h231v-694h-231v694zm246-908q-1-52-36-86t-93-34-94.5 34-36.5 86q0 51 35.5 85.5t92.5 34.5h1q59 0 95-34.5t36-85.5zm585 908h231v-398q0-154-73-233t-193-79q-136 0-209 117h2v-101h-231q3 66 0 694h231v-388q0-38 7-56 15-35 45-59.5t74-24.5q116 0 116 157v371zm468-998v960q0 119-84.5 203.5t-203.5 84.5h-960q-119 0-203.5-84.5t-84.5-203.5v-960q0-119 84.5-203.5t203.5-84.5h960q119 0 203.5 84.5t84.5 203.5z"/></svg></a>
        </li>
        <li>
          <a href="https://github.com/PhilibertDugas" target="_blank"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M522 1352q-8 9-20-3-13-11-4-19 8-9 20 3 12 11 4 19zm-42-61q9 12 0 19-8 6-17-7t0-18q9-7 17 6zm-61-60q-5 7-13 2-10-5-7-12 3-5 13-2 10 5 7 12zm31 34q-6 7-16-3-9-11-2-16 6-6 16 3 9 11 2 16zm129 112q-4 12-19 6-17-4-13-15t19-7q16 5 13 16zm63 5q0 11-16 11-17 2-17-11 0-11 16-11 17-2 17 11zm58-10q2 10-14 14t-18-8 14-15q16-2 18 9zm964-956v960q0 119-84.5 203.5t-203.5 84.5h-224q-16 0-24.5-1t-19.5-5-16-14.5-5-27.5v-239q0-97-52-142 57-6 102.5-18t94-39 81-66.5 53-105 20.5-150.5q0-121-79-206 37-91-8-204-28-9-81 11t-92 44l-38 24q-93-26-192-26t-192 26q-16-11-42.5-27t-83.5-38.5-86-13.5q-44 113-7 204-79 85-79 206 0 85 20.5 150t52.5 105 80.5 67 94 39 102.5 18q-40 36-49 103-21 10-45 15t-57 5-65.5-21.5-55.5-62.5q-19-32-48.5-52t-49.5-24l-20-3q-21 0-29 4.5t-5 11.5 9 14 13 12l7 5q22 10 43.5 38t31.5 51l10 23q13 38 44 61.5t67 30 69.5 7 55.5-3.5l23-4q0 38 .5 103t.5 68q0 22-11 33.5t-22 13-33 1.5h-224q-119 0-203.5-84.5t-84.5-203.5v-960q0-119 84.5-203.5t203.5-84.5h960q119 0 203.5 84.5t84.5 203.5z"/></svg></a>
        </li>
        <li>
          <a href="https://twitter.com/DugasPhilibert" target="_blank"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1408 610q-56 25-121 34 68-40 93-117-65 38-134 51-61-66-153-66-87 0-148.5 61.5t-61.5 148.5q0 29 5 48-129-7-242-65t-192-155q-29 50-29 106 0 114 91 175-47-1-100-26v2q0 75 50 133.5t123 72.5q-29 8-51 8-13 0-39-4 21 63 74.5 104t121.5 42q-116 90-261 90-26 0-50-3 148 94 322 94 112 0 210-35.5t168-95 120.5-137 75-162 24.5-168.5q0-18-1-27 63-45 105-109zm256-194v960q0 119-84.5 203.5t-203.5 84.5h-960q-119 0-203.5-84.5t-84.5-203.5v-960q0-119 84.5-203.5t203.5-84.5h960q119 0 203.5 84.5t84.5 203.5z"/></svg></a>
        </li>
      </ul>
      <h2>Philibert Dugas</h2>
      <h6>Developer <a href="https://www.shopify.ca/">@Shopify</a>, software enthusiast</h6>
    </div>
    <div class="nine columns content">
      <article>
  <h2 id="parsing-json-and-sending-requests">Parsing JSON and sending requests</h2>

<p><em>July 9th, 2016</em></p>

<p>This week I focused on getting a minimal test plan defined in JSON and executing it. Defining the plan wasn’t too hard, I took a trimmed down version of <a href="https://github.com/dudang/golt/blob/master/test/golt-test.json">Golt’s plan</a>. The light version looks like <a href="https://github.com/PhilibertDugas/elixir-learning/blob/master/multithread/elt-test.json">this</a>. This test will start 10 threads. Each of them will execute 3 GET requests to my blog. Simple enough, let the hacking begin.</p>

<h4 id="parsing-json">Parsing JSON</h4>
<p>First, I need to read the file. Once I have it’s content, I want to parse the JSON into a struct. Not going to implement my own JSON parser, <a href="https://github.com/devinus/poison">Poison</a> is the library I’m using to do that.</p>

<noscript><pre>400: Invalid request
</pre></noscript>
<script src="https://gist.github.com/1df360053e0a3cba5643ecf5516cdc86.js"> </script>

<p>So we have a module <code class="highlighter-rouge">Runner</code> which will be acting as the entry point for our program. The new function <code class="highlighter-rouge">get_struct</code> reads the file “elt-test.json”. It then transform the content into the <code class="highlighter-rouge">Elt</code> struct defined <a href="https://github.com/PhilibertDugas/elixir-learning/blob/master/multithread/lib/elt.ex">here</a>. Nothing too tricky. Time to start launching the threads. Each of these threads will launch their own series of requests.</p>

<h4 id="launching-threads">Launching Threads</h4>

<noscript><pre>400: Invalid request
</pre></noscript>
<script src="https://gist.github.com/badb971bd3d87978f7e7a4d390566d35.js"> </script>

<p>We introduced quite a lot of code here, let’s go through it. Right now, I only want to worry about the first element of the <code class="highlighter-rouge">Elt</code> list. The line <code class="highlighter-rouge">[ thread_group | _ ]</code> takes the head of the list and assigns it to <code class="highlighter-rouge">thread_group</code>. The rest of the list is discarded since I’m using the <code class="highlighter-rouge">_</code> operator.</p>

<p>I have my thread group structure ready to get kicked off. The function <code class="highlighter-rouge">launch_threads</code> is responsible for this. An amazing feature of elixir is how you can use pattern matching in function arguments. I’m expecting a map with the following keys: <code class="highlighter-rouge"><span class="p">{</span><span class="w"> </span><span class="nt">"repetitions"</span><span class="w"> </span><span class="err">=&gt;,</span><span class="w"> </span><span class="nt">"requests"</span><span class="w"> </span><span class="err">=&gt;,</span><span class="w"> </span><span class="nt">"threads"</span><span class="w"> </span><span class="err">=&gt;</span><span class="w"> </span><span class="err">}</span></code>. The declaration above assigns each value to the variable declared in the function signature. Moreover, the <code class="highlighter-rouge">param</code> variable is assigned the whole map value.</p>

<p>Now, I have 10 threads to start. In an imperative language, I could loop 10 times and start background threads. In this context, I will use recursion 10 times. Using the <code class="highlighter-rouge">case</code> statement, I can inspect the value of <code class="highlighter-rouge">threads</code>. If it’s at 0, my loop is finished and I can output a message to the console. For other values, I’m starting a <code class="highlighter-rouge">Task</code> using <a href="http://philibertd.com/2016/07/02/load-testing.html">HTTPSender</a> defined in last week’s post. We see here, <code class="highlighter-rouge">launch_request</code> is not currently implemented. It will be in the next iteration so no need to worry about for now.</p>

<p>Back to launching the following threads. I’m calling the same method, decrementing <code class="highlighter-rouge">threads</code> value by 1 to avoid looping infinitely. Note the syntax, <code class="highlighter-rouge">%{ param | "threads" =&gt; threads - 1}</code>. This creates a new map, having all of <code class="highlighter-rouge">param</code> values except for <code class="highlighter-rouge">"threads"</code>.</p>

<h4 id="launching-requests">Launching Requests</h4>

<noscript><pre>400: Invalid request
</pre></noscript>
<script src="https://gist.github.com/8cac66be77b1ac5a3dcaec587e1ba7e8.js"> </script>

<p>The last piece of the puzzle is to send HTTP Requests. The new function <code class="highlighter-rouge">launch_request</code> receives a url, a number of repetitions and a receiver pid. To know more about this <code class="highlighter-rouge">pid</code>, make sure to read last week’s post. Using recursion again, I’m using the <code class="highlighter-rouge">HTTPRequest</code> module which sends asynchronous requests. Once that’s done, I’m repeating the function until there are no more repetition. Simple enough.</p>

<h4 id="result">Result</h4>

<p>What’s the point of coding all of this if we don’t see it in action? Time for some demo!</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="n">iex</span><span class="o">&gt;</span> <span class="no">Runner</span><span class="o">.</span><span class="n">main</span>
<span class="no">Finished</span> <span class="n">starting</span> <span class="n">threads</span>
<span class="ss">:ok</span>
<span class="n">finished</span> <span class="n">sending</span> <span class="n">request</span>
<span class="n">finished</span> <span class="n">sending</span> <span class="n">request</span>
<span class="n">finished</span> <span class="n">sending</span> <span class="n">request</span>
<span class="n">finished</span> <span class="n">sending</span> <span class="n">request</span>
<span class="n">finished</span> <span class="n">sending</span> <span class="n">request</span>
<span class="n">finished</span> <span class="n">sending</span> <span class="n">request</span>
<span class="n">finished</span> <span class="n">sending</span> <span class="n">request</span>
<span class="n">finished</span> <span class="n">sending</span> <span class="n">request</span>
<span class="n">finished</span> <span class="n">sending</span> <span class="n">request</span>
<span class="n">finished</span> <span class="n">sending</span> <span class="n">request</span>
<span class="m">200</span>
<span class="m">200</span>
<span class="m">200</span>
<span class="m">200</span>
<span class="m">200</span>
<span class="m">200</span>
<span class="m">200</span>
<span class="m">200</span>
<span class="m">200</span>
<span class="m">200</span>
<span class="m">200</span>
<span class="no">Request</span> <span class="no">Chunk</span> <span class="no">Received</span>
<span class="no">Request</span> <span class="no">Chunk</span> <span class="no">Received</span>
<span class="no">Request</span> <span class="no">Chunk</span> <span class="no">Received</span>
<span class="m">200</span>
<span class="no">Request</span> <span class="no">Chunk</span> <span class="no">Received</span>
<span class="no">Request</span> <span class="no">Chunk</span> <span class="no">Received</span>
<span class="no">Request</span> <span class="no">Chunk</span> <span class="no">Received</span>
<span class="no">Request</span> <span class="no">Chunk</span> <span class="no">Received</span>
<span class="no">Request</span> <span class="no">Chunk</span> <span class="no">Received</span>
<span class="no">Request</span> <span class="no">Chunk</span> <span class="no">Received</span>
<span class="k">end</span>
<span class="k">end</span>
<span class="k">end</span>
<span class="no">Request</span> <span class="no">Chunk</span> <span class="no">Received</span>
<span class="k">end</span>
<span class="k">end</span>
<span class="k">end</span>
<span class="k">end</span>
<span class="k">end</span>
<span class="k">end</span>
<span class="k">end</span>
<span class="o">.........</span></code></pre></figure>

<p>The output is super interesting. First it finishes booting all the threads. Then it finishes sending all the requests. Since they are asynchronous, we don’t get the result right away. Once the requests are done, we start receiving the <code class="highlighter-rouge">AsyncHeader</code>, <code class="highlighter-rouge">AsyncChunk</code>, and <code class="highlighter-rouge">AsyncEnd</code> structs from HTTPotion. Some requests seem a bit slower then others. Note the <code class="highlighter-rouge">AsyncHeader</code> that arrived after 3 <code class="highlighter-rouge">AsyncChunk</code>. With a longer running test (more requests), we would probably see much more of them. I trimmed down the output to the first 10 requests to maintain readability. In your own console, you would see this output keeps going for all 30 requests.</p>

<h4 id="conclusion">Conclusion</h4>

<p>This first step was for the simplest scenario. Still, I’m super impressed by the power of Elixir. In around 33 lines of code, we can get a command line load testing tool. While Elt is still limited, I plan to keep exploring and learning Elixir through this project. One thing I want to approach soon is Elixir testing, logging and eventually the <a href="http://www.phoenixframework.org/">Phoenix framework</a>.</p>

</article>

<p>You can find me on Twitter <a href="https://twitter.com/DugasPhilibert">@DugasPhilibert</a></p>

    </div>
  </div>
</div>

  </body>
</html>
