<!DOCTYPE html>
<html>
  <head>
    <!-- Begin Jekyll SEO tag v2.0.0 -->
<title>Background Job - Philibert&#8217;s website</title>
<meta property="og:title" content="Background Job" />
<meta name="description" content="Background job" />
<meta property="og:description" content="Background job" />
<meta property="og:site_name" content="Philibert’s website" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2016-08-22T00:00:00-04:00" />
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "Background Job",
    "datePublished": "2016-08-22T00:00:00-04:00",
    "description": "Background job",
    "url": "/2016/08/22/background-job.html"
  }
</script>
<!-- End Jekyll SEO tag -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="keywords" content="Philibert Dugas, Philibertd">
    <meta name="author" content="Philibert Dugas">
    <link href="/favicon.ico" rel="shortcut icon" type="image/x-icon">
    <link href="/static/css/skeleton.css" rel="stylesheet">
    <link href="/static/css/style.css" rel="stylesheet">
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-76867217-1', 'auto');
      ga('send', 'pageview');
    </script>
  </head>

  <body>
    <div class="container">
  <div class="row">
    <div class="profile three columns">
      <a href="/"><img id="avatar" src="/static/images/phili.png" alt="avatar"/></a>
      <ul id="social">
        <li>
          <a href="https://ca.linkedin.com/in/philibertdugas" target="_blank"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M365 1414h231v-694h-231v694zm246-908q-1-52-36-86t-93-34-94.5 34-36.5 86q0 51 35.5 85.5t92.5 34.5h1q59 0 95-34.5t36-85.5zm585 908h231v-398q0-154-73-233t-193-79q-136 0-209 117h2v-101h-231q3 66 0 694h231v-388q0-38 7-56 15-35 45-59.5t74-24.5q116 0 116 157v371zm468-998v960q0 119-84.5 203.5t-203.5 84.5h-960q-119 0-203.5-84.5t-84.5-203.5v-960q0-119 84.5-203.5t203.5-84.5h960q119 0 203.5 84.5t84.5 203.5z"/></svg></a>
        </li>
        <li>
          <a href="https://github.com/PhilibertDugas" target="_blank"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M522 1352q-8 9-20-3-13-11-4-19 8-9 20 3 12 11 4 19zm-42-61q9 12 0 19-8 6-17-7t0-18q9-7 17 6zm-61-60q-5 7-13 2-10-5-7-12 3-5 13-2 10 5 7 12zm31 34q-6 7-16-3-9-11-2-16 6-6 16 3 9 11 2 16zm129 112q-4 12-19 6-17-4-13-15t19-7q16 5 13 16zm63 5q0 11-16 11-17 2-17-11 0-11 16-11 17-2 17 11zm58-10q2 10-14 14t-18-8 14-15q16-2 18 9zm964-956v960q0 119-84.5 203.5t-203.5 84.5h-224q-16 0-24.5-1t-19.5-5-16-14.5-5-27.5v-239q0-97-52-142 57-6 102.5-18t94-39 81-66.5 53-105 20.5-150.5q0-121-79-206 37-91-8-204-28-9-81 11t-92 44l-38 24q-93-26-192-26t-192 26q-16-11-42.5-27t-83.5-38.5-86-13.5q-44 113-7 204-79 85-79 206 0 85 20.5 150t52.5 105 80.5 67 94 39 102.5 18q-40 36-49 103-21 10-45 15t-57 5-65.5-21.5-55.5-62.5q-19-32-48.5-52t-49.5-24l-20-3q-21 0-29 4.5t-5 11.5 9 14 13 12l7 5q22 10 43.5 38t31.5 51l10 23q13 38 44 61.5t67 30 69.5 7 55.5-3.5l23-4q0 38 .5 103t.5 68q0 22-11 33.5t-22 13-33 1.5h-224q-119 0-203.5-84.5t-84.5-203.5v-960q0-119 84.5-203.5t203.5-84.5h960q119 0 203.5 84.5t84.5 203.5z"/></svg></a>
        </li>
        <li>
          <a href="https://twitter.com/DugasPhilibert" target="_blank"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1408 610q-56 25-121 34 68-40 93-117-65 38-134 51-61-66-153-66-87 0-148.5 61.5t-61.5 148.5q0 29 5 48-129-7-242-65t-192-155q-29 50-29 106 0 114 91 175-47-1-100-26v2q0 75 50 133.5t123 72.5q-29 8-51 8-13 0-39-4 21 63 74.5 104t121.5 42q-116 90-261 90-26 0-50-3 148 94 322 94 112 0 210-35.5t168-95 120.5-137 75-162 24.5-168.5q0-18-1-27 63-45 105-109zm256-194v960q0 119-84.5 203.5t-203.5 84.5h-960q-119 0-203.5-84.5t-84.5-203.5v-960q0-119 84.5-203.5t203.5-84.5h960q119 0 203.5 84.5t84.5 203.5z"/></svg></a>
        </li>
      </ul>
      <h2>Philibert Dugas</h2>
      <h6>Developer <a href="https://www.shopify.ca/">@Shopify</a>, software enthusiast</h6>
    </div>
    <div class="nine columns content">
      <article>
  <h2 id="background-job">Background job</h2>

<p><em>August 22nd, 2016</em></p>

<p>In the last blog post, I showed how I migrated my load testing tool to a web application.
Using the Phoenix framework, it was straight forward to get started and have early results.
The web application could trigger load test and display results.
While this was exciting to begin with, it presents an issue.
Waiting for a load test to finish can be a long process.
During that waiting time, we are holding a connection open to the server.
It wouldn’t be hard to open many tabs, and launch long running tests before the server starts blowing up.</p>

<p>This week, I focused on making these tests asynchronous so that the connection to the server is released.
By refreshing a “progress” page, it’s possible to see if the test is still running.
In the world of Rails, it would be the equivalent of launching a job.</p>

<h4 id="launching-the-task">Launching the task</h4>

<p>I thought at first that this was going to be an easy thing to do, <strong>wrong</strong>.
Phoenix doesn’t come with a job framework like <a href="http://guides.rubyonrails.org/active_job_basics.html">Rails do</a>
With a little bit of research, I found some open source frameworks like <a href="https://github.com/akira/exq">exq</a>.
While some of these libraries are most likely the right solution long term, I wanted to try something simpler.</p>

<p>The simplest iteration I could think about was the following:</p>

<ol>
  <li>Trigger a load test with the <code class="highlighter-rouge">create</code> action</li>
  <li>Start an asynchronous job and redirect the user to a “in progress” page</li>
  <li>Verify the load test status when the user refreshes the “in progress” page</li>
</ol>

<p>Triggering a load test isn’t too hard, we’ve been doing this for the past few week.
Retrieving this load test in the context of another action was more challenging.
Essentially, we need a global state on the server side.</p>

<p>Having a global state is not a good idea when your application needs to scale, but it’s easy to implement.
Since I like to make small steps, I started this way.</p>

<noscript><pre>400: Invalid request
</pre></noscript>
<script src="https://gist.github.com/b686d36e74ac17721a820d247af7cf30.js"> </script>

<p>This code snippet shows the <code class="highlighter-rouge">create</code> action of the controller. It starts by using <code class="highlighter-rouge">Task.start</code> to launch the load test.
We don’t need to use <code class="highlighter-rouge">Task.async</code> since we are not going to await for the end of this process in this function.
What we see afterward is storing the state in a global <code class="highlighter-rouge">Map</code>. Essentially, storing a hard-coded string as the key, with the task as the value.
This allows us to retrieve this task in another action. For this to work, we need some configuration in <code class="highlighter-rouge">lib/elt.ex</code></p>

<noscript><pre>400: Invalid request
</pre></noscript>
<script src="https://gist.github.com/b8cc19984c0c368ad49b180d6872c234.js"> </script>

<p>The important part of this section is at line 13. When the Phoenix server starts, it calls <code class="highlighter-rouge">Map.Bucket.start_link</code>.
It also makes this process supervised, meaning that it will be restarted if it crashes.
With this, we can store all our tasks in a global <code class="highlighter-rouge">Map</code></p>

<h4 id="retrieving-the-task">Retrieving the task</h4>

<p>Retrieving the task at this point is trivial. Simply query the map with the appropriate id to get the task.</p>

<noscript><pre>400: Invalid request
</pre></noscript>
<script src="https://gist.github.com/2f477e75c543430729a57909ec9d5c91.js"> </script>

<p>Right now, the key is hardcoded with <strong>“1”</strong>. This needs to be changed and passed as a parameter to the function.
Once I retrieved the load test in another action, using <code class="highlighter-rouge">Process.alive?(pid)</code> tells me if the test is over or not.
This is a very simple check, and it could be elaborated further in the future.</p>

<p>If the process is still running, we render a “progress” page explaining how the load test is still running.
In the other case, we redirect the user to the list of results.</p>

<h4 id="result">Result</h4>

<p>It’s always rewarding to see some results :)</p>

<p><a href="https://www.youtube.com/watch?v=S5q5gGLXqbc&amp;feature=youtu.be"><img src="http://img.youtube.com/vi/S5q5gGLXqbc/0.jpg" alt="Async load test" /></a></p>

<h4 id="improvements">Improvements</h4>

<p>The current implementation works fine for quick development, but it’s worth thinking about potential improvements.</p>

<ol>
  <li>Using an external queue would allow better scalability</li>
  <li>Supervising the load tests to handle crashes and stuff</li>
  <li>Updating the “progress” page with websocket</li>
</ol>

<p>There’s many things that I look forward to, stay tuned for the progress of this project !</p>

</article>

<p>You can find me on Twitter <a href="https://twitter.com/DugasPhilibert">@DugasPhilibert</a></p>

    </div>
  </div>
</div>

  </body>
</html>
